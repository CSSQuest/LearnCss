<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Editor — LearnCSS</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="editor-page">
    
    <header class="site-header">
        <div class="container header-inner">
            <a class="brand" href="index.html">
                <span class="brand-mark" aria-hidden="true">*</span>
                <span class="brand-text">LearnCSS</span>
            </a>
            <nav class="site-nav">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="tutorials.html">Tutorials</a></li>
                    <li><a href="editor.html" class="active">Editor</a></li>
                    <li><a href="about.html">About</a></li>
                </ul>
                <div class="nav-cta">
                    <a class="btn btn-primary" href="index.html#start">Start Learning</a>
                </div>
            </nav>
        </div>
    </header>

    <main class="editor-workspace" id="workspace">
        
        <div class="code-panel" id="codePanel">
            
            <div class="html-section" id="htmlSection">
                <div class="editor-toolbar">
                    <span class="lang-label html">HTML</span>
                    <span class="file-name">index.html</span>
                </div>

                <div class="code-wrap">
                    <div class="line-highlight" id="htmlHL"></div>
                    <div class="code-cursor" id="htmlCursor"></div>
                    <textarea id="html-code" spellcheck="false" placeholder=""></textarea>
                </div>
            </div>


            <div class="resizer resizer-y" id="resizerY"></div>

                <div class="css-section" id="cssSection">
                    <div class="editor-toolbar">
                        <span class="lang-label css">CSS</span>
                        <span class="file-name">style.css</span>
                    </div>

                    <div class="code-wrap">
                    <div class="line-highlight" id="cssHL"></div>
                    <div class="code-cursor" id="cssCursor"></div>
                    <textarea id="css-code" spellcheck="false" placeholder="/* CSS here */"></textarea>
                    </div>

                </div>

        </div>

        <div class="resizer resizer-x" id="resizerX"></div>

        <div class="preview-panel" id="previewPanel">
            <div class="editor-toolbar preview-header">
                <span class="lang-label preview">Preview</span>
                <button id="refresh-btn" style="background:none; border:none; color:inherit; cursor:pointer; font-size:1.2rem;">↻</button>
            </div>
            <iframe id="preview-frame" sandbox="allow-scripts allow-same-origin"></iframe>
            <div class="iframe-shield"></div>
        </div>

    </main>

    <script>
        // --- 1. GLOBAL DEĞİŞKENLER ---
        const htmlInput = document.getElementById('html-code');
        const cssInput = document.getElementById('css-code');
        const previewFrame = document.getElementById('preview-frame');
        const refreshBtn = document.getElementById('refresh-btn');
        
        const htmlHL = document.getElementById("htmlHL");
        const cssHL = document.getElementById("cssHL");
        const htmlCursor = document.getElementById("htmlCursor");
        const cssCursor = document.getElementById("cssCursor");

        // --- 2. PREVIEW GÜNCELLEME ---
        function updatePreview() {
            const html = htmlInput.value;
            const css = `<style>${cssInput.value}</style>`;
            const doc = previewFrame.contentDocument || previewFrame.contentWindow.document;
            doc.open();
            doc.write(css + html);
            doc.close();
        }

        htmlInput.addEventListener('input', () => {
            updatePreview();
            syncHighlight(htmlInput, htmlHL, htmlCursor);
        });
        cssInput.addEventListener('input', () => {
            updatePreview();
            syncHighlight(cssInput, cssHL, cssCursor);
        });
        refreshBtn.addEventListener('click', updatePreview);

        // --- 3. RESIZER LOGIC ---
        const workspace = document.getElementById('workspace');
        const codePanel = document.getElementById('codePanel');
        const htmlSection = document.getElementById('htmlSection'); 
        const resizerX = document.getElementById('resizerX'); 
        const resizerY = document.getElementById('resizerY'); 

        let isResizingX = false;
        let isResizingY = false;

        resizerX.addEventListener('mousedown', (e) => {
            isResizingX = true;
            document.body.classList.add('is-resizing');
            e.preventDefault();
        });

        resizerY.addEventListener('mousedown', (e) => {
            isResizingY = true;
            document.body.classList.add('is-resizing');
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizingX && !isResizingY) return;

            if (isResizingX) {
                const workspaceRect = workspace.getBoundingClientRect();
                const newWidth = e.clientX - workspaceRect.left;
                if (newWidth > 150 && newWidth < workspaceRect.width - 150) {
                    const newWidthPercent = (newWidth / workspaceRect.width) * 100;
                    codePanel.style.width = `${newWidthPercent}%`;
                }
            }

            if (isResizingY) {
                const panelRect = codePanel.getBoundingClientRect();
                const newHeight = e.clientY - panelRect.top;
                if (newHeight > 100 && newHeight < panelRect.height - 100) {
                    htmlSection.style.height = `${newHeight}px`;
                }
            }
        });

        document.addEventListener('mouseup', () => {
            isResizingX = false;
            isResizingY = false;
            document.body.classList.remove('is-resizing');
        });

        // --- 4. HIGHLIGHT & TYPING EFFECT MANTIĞI ---
        
        function getLineHeight(textarea) {
            const cs = window.getComputedStyle(textarea);
            const lh = parseFloat(cs.lineHeight);
            return Number.isFinite(lh) ? lh : 22;
        }

        function updateHighlightUI(textarea, hlEl, cursorEl, lineIndex, colIndex = 0) {
            const lh = getLineHeight(textarea);
            hlEl.style.setProperty("--hl-h", `${lh}px`);

            const top = 10 + (lineIndex * lh) - textarea.scrollTop;
            hlEl.style.setProperty("--hl-top", `${top}px`);

            // Cursor pozisyonu (basit hesaplama)
            const charWidth = 8.5; // Monospace font ortalama genişlik
            const left = 14 + (colIndex * charWidth);

            cursorEl.style.top = `${top}px`;
            cursorEl.style.left = `${left}px`;
        }

        function syncHighlight(textarea, hlEl, cursorEl) {
            // Mevcut cursor pozisyonuna göre highlight'ı güncelle
            const textUpToCursor = textarea.value.substring(0, textarea.selectionStart);
            const lineIndex = textUpToCursor.split("\n").length - 1;
            // Kolon indeksini bulmak için son satırın uzunluğuna bakabiliriz ama şimdilik sadece satır senkronu yeterli
            updateHighlightUI(textarea, hlEl, cursorEl, lineIndex, 0);
        }

        // Scroll senkronizasyonu
        function bindScrollSync(textarea, hlEl, cursorEl) {
            textarea.addEventListener("scroll", () => {
                // Scroll olduğunda highlight pozisyonunu güncelle
                // Basitçe o anki satırı koru ama scroll offsetini hesaba kat
                // (Daha gelişmiş editörlerde bu daha karmaşıktır, burada basit tutuyoruz)
                hlEl.style.setProperty("--hl-top", `${10 - textarea.scrollTop}px`);
                cursorEl.style.marginTop = `-${textarea.scrollTop}px`; // Cursor'ı kaydır
            });
            
            // Tıklama ile highlight güncelleme
            textarea.addEventListener("click", () => syncHighlight(textarea, hlEl, cursorEl));
            textarea.addEventListener("keyup", () => syncHighlight(textarea, hlEl, cursorEl));
        }

        async function typeInto(textarea, hlEl, cursorEl, text, speedMs = 5) {
            textarea.value = "";
            updateHighlightUI(textarea, hlEl, cursorEl, 0, 0);

            let lineIndex = 0;
            let colIndex = 0;

            for (let i = 0; i < text.length; i++) {
                const ch = text[i];
                textarea.value += ch;

                if (ch === "\n") {
                    lineIndex++;
                    colIndex = 0;
                    // Satır sonu beklemesi
                    if(speedMs > 0) await new Promise(r => setTimeout(r, speedMs * 3));
                } else {
                    colIndex++;
                }

                textarea.scrollTop = textarea.scrollHeight;
                updateHighlightUI(textarea, hlEl, cursorEl, lineIndex, colIndex);
                
                // Her karakterde önizlemeyi güncellemek yorabilir, 
                // ama efekt için güzeldir. Performans sorunu olursa burayı döngü dışına al.
                if (i % 5 === 0) updatePreview(); 

                if(speedMs > 0) await new Promise(r => setTimeout(r, speedMs));
            }
            updatePreview(); // Döngü bitince son kez güncelle
        }

        // --- 5. ANA YÜKLEME (INIT) ---
        window.addEventListener("load", async () => {
            bindScrollSync(htmlInput, htmlHL, htmlCursor);
            bindScrollSync(cssInput, cssHL, cssCursor);

            // 1. Veriyi Oku
            const storedHTML = localStorage.getItem("editorHTML");
            const storedCSS = localStorage.getItem("editorCSS");

            // 2. Fallback (Varsayılan) Kodlar
            const fallbackHTML = `<div class="container">
  <div class="card">
    <h2>Hello CSS!</h2>
    <p>Welcome to the Live Editor.</p>
    <button>Hover Me</button>
  </div>
</div>`;

            const fallbackCSS = `body {
  font-family: system-ui;
  background: #0b1220;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100vh;
  margin: 0;
}
.card {
  background: rgba(255,255,255,0.06);
  padding: 2rem;
  border-radius: 1rem;
  border: 1px solid rgba(255,255,255,0.12);
  text-align: center;
}
button {
  background: #325dff;
  color: white;
  border: none;
  padding: 0.8rem 1.5rem;
  border-radius: 0.5rem;
  cursor: pointer;
  margin-top: 1rem;
}
button:hover { opacity: 0.9; }`;

            // 3. Hangi kodu kullanacağımıza karar verelim
            // Eğer localStorage boşsa veya sadece boşluksa fallback kullan
            const hasHTML = storedHTML && storedHTML.trim().length > 0;
            const hasCSS = storedCSS && storedCSS.trim().length > 0;

            const finalHTML = hasHTML ? storedHTML : fallbackHTML;
            // CSS bazen sadece yorum satırı olabilir, onu da boş saymayalım
            const finalCSS = (hasCSS || storedCSS === "") ? storedCSS : fallbackCSS;

            // 4. Daktilo Efektiyle Yaz (Sırayla)
            // Hız: 8ms. Eğer çok uzunsa hızı 0 yapıp anında yazdırabilirsin.
            await typeInto(htmlInput, htmlHL, htmlCursor, finalHTML, 8);
            await typeInto(cssInput, cssHL, cssCursor, finalCSS, 8);

            // 5. İş bitti, localStorage'ı temizle ki sonraki girişlerde karışmasın
            localStorage.removeItem("editorHTML");
            localStorage.removeItem("editorCSS");
        });

    </script>

    <footer class="site-footer">
        <div class="container footer-inner">
            <p>© <span id="year"></span> NextHive — LearnCSS</p>
            <nav aria-label="Footer">
                <a href="#">Privacy</a>
                <a href="#">Terms</a>
                <a href="about.html">Contact</a>
            </nav>
        </div>
    </footer>

    <script>
        document.getElementById('year').textContent=new Date().getFullYear();
    </script>
</body>
</html>